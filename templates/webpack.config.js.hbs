//@ts-check
"use strict";

const path = require("path");
const webpack = require("webpack");
const { execSync } = require("child_process");

// Get package info
const pkg = require("./package.json");

// Get git SHA
let gitSha = "unknown";
try {
  gitSha = execSync("git rev-parse --short HEAD", { encoding: "utf-8" }).trim();
} catch {
  // Ignore git errors
}

/**@type {import('webpack').Configuration}*/
const config = {
  target: "node",
  mode: "none",
  entry: "./src/extension.ts",
  output: {
    path: path.resolve(__dirname, "out"),
    filename: "extension.js",
    libraryTarget: "commonjs2",
  },
  devtool: "nosources-source-map",
  externals: {
    vscode: "commonjs vscode",
  },
  resolve: {
    extensions: [".ts", ".js"],
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        exclude: /node_modules/,
        use: [
          {
            loader: "ts-loader",
          },
        ],
      },
    ],
  },
  plugins: [
    new webpack.DefinePlugin({
      __EXTENSION_ID__: JSON.stringify(pkg.publisher + "." + pkg.name),
      __EXTENSION_VERSION__: JSON.stringify(pkg.version),
      __CORE_EXTENSION_ID__: JSON.stringify(pkg.coreExtensionId),
      __GIT_SHA__: JSON.stringify(gitSha),
      __BUILD_TIME__: JSON.stringify(new Date().toISOString()),
    }),
  ],
};

module.exports = config;
